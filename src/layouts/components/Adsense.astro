---
import config from "@/config/config.json";

const ADSENSE_PUB_ID = config.envConfig.adsense_pub_id;
const ADSENSE_INARTICLE_SLOT_ID = config.envConfig.adsense_inarticle_slot_id;
const ADSENSE_TEST_MODE = config.envConfig.adsense_test_mode;
---

<script is:inline define:vars={{ ADSENSE_PUB_ID, ADSENSE_INARTICLE_SLOT_ID, ADSENSE_TEST_MODE }}>
  function insertInArticleAds() {
    const h2Elements = document.querySelectorAll("h2");
    let insertCount = 0;

    for (let i = 0; i < h2Elements.length; i++) {
      if (i % 2 !== 0) {
        const adCode = `
      <ins class="adsbygoogle" style="display:block"
           data-ad-client="ca-pub-${ADSENSE_PUB_ID}"
           data-ad-slot="${ADSENSE_INARTICLE_SLOT_ID}"
           data-ad-layout="in-article"
           data-ad-format="fluid"
           ${ADSENSE_TEST_MODE ? 'data-adtest="on"' : ''}>
      </ins>`;
        insertCount++;
        h2Elements[i].insertAdjacentHTML("beforebegin", adCode);
      }
    }
    Array(insertCount).fill().forEach(() => (adsbygoogle = window.adsbygoogle || []).push({}));
  }

  window.addEventListener(
    "scroll",
    function () {
      console.log("Activate Google AdSense");

      insertInArticleAds();

      let ads = document.createElement("script");
      ads.type = "text/javascript";
      ads.async = true;
      ads.crossOrigin = "anonymous";
      ads.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-${ADSENSE_PUB_ID}`;
      let ref = document.getElementsByTagName("script")[0];
      ref.parentNode?.insertBefore(ads, ref);
    },
    { capture: true, once: true },
  );
</script>
